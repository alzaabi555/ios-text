name: Build Android APK (Corrected Open Box)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Flet
        run: pip install flet

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Prepare Files
        run: |
          rm -rf build_dir
          mkdir build_dir
          cp main.py build_dir/
          if [ -f "icon.png" ]; then cp icon.png build_dir/; fi
          echo "flet" > build_dir/requirements.txt
          echo "openpyxl" >> build_dir/requirements.txt

      - name: GENERATE FLUTTER PROJECT
        run: |
          cd build_dir
          # تم التصحيح: أزلنا --org لأنه غير مدعوم
          flet create . --project StudentApp --description "المتابع المدرسي"

      - name: FORCE MANIFEST PATCH (White Screen Fix)
        shell: python
        run: |
          import os
          
          # البحث الديناميكي عن ملف المانيفيست
          search_dir = "build_dir"
          manifest_path = None
          
          for root, dirs, files in os.walk(search_dir):
              if "AndroidManifest.xml" in files and "src/main" in root:
                  manifest_path = os.path.join(root, "AndroidManifest.xml")
                  break
          
          if not manifest_path:
              print("Error: Could not find generated AndroidManifest.xml")
              exit(1)
              
          print(f"Found Manifest at: {manifest_path}")
          
          with open(manifest_path, "r") as f:
              content = f.read()
              
          # 1. أهم خطوة: السماح بالاتصال المحلي (Cleartext)
          # هذا هو السبب الرئيسي للشاشة البيضاء في Flet
          if 'android:usesCleartextTraffic="true"' not in content:
              content = content.replace("<application", '<application android:usesCleartextTraffic="true"')
              print("Critical Fix: Cleartext Traffic Enabled ✅")

          # 2. إضافة أذونات الإنترنت والتخزين
          permissions = '''
          <uses-permission android:name="android.permission.INTERNET"/>
          <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
          <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
          '''
          
          if "android.permission.INTERNET" not in content:
              content = content.replace("<application", f"{permissions}\n    <application")
              print("Permissions Injected ✅")
              
          # 3. تعطيل Impeller (احتياط)
          impeller_tag = '<meta-data android:name="io.flutter.embedding.android.EnableImpeller" android:value="false" />'
          if "EnableImpeller" not in content:
               content = content.replace("</application>", f"    {impeller_tag}\n    </application>")
               print("Impeller Disabled ✅")

          # 4. تعريب الاسم
          content = content.replace('android:label="StudentApp"', 'android:label="المتابع المدرسي"')
          
          with open(manifest_path, "w") as f:
              f.write(content)

      - name: BUILD APK MANUALLY
        run: |
          # العثور على مجلد المشروع المولد
          PROJECT_DIR=$(find build_dir -maxdepth 2 -type d -name "android" | xargs dirname)
          echo "Project generated in: $PROJECT_DIR"
          
          cd "$PROJECT_DIR"
          
          # خطوة هامة: إضافة مكتبة flet لبيئة flutter
          flutter pub add flet
          flutter pub get
          
          # البناء النهائي
          flutter build apk --release --verbose

      - name: Find and Rename APK
        run: |
          APK_PATH=$(find . -name "*.apk" | grep "release" | head -n 1)
          if [ -z "$APK_PATH" ]; then APK_PATH=$(find . -name "*.apk" | head -n 1); fi
          if [ -z "$APK_PATH" ]; then echo "Error: APK not found!"; exit 1; fi
          mv "$APK_PATH" StudentApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: StudentApp.apk
