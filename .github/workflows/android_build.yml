name: Build Android APK (Permissions & Impeller Fix)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Flet
        run: pip install flet

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Create Requirements File
        run: |
          echo "flet" > requirements.txt
          echo "certifi" >> requirements.txt
          echo "typing_extensions" >> requirements.txt
          echo "urllib3" >> requirements.txt
          echo "requests" >> requirements.txt
          echo "charset-normalizer" >> requirements.txt
          echo "idna" >> requirements.txt
          echo "openpyxl" >> requirements.txt

      - name: Prepare Icon
        run: |
          if [ -f "icon.png" ]; then
            echo "Icon found! ✅"
            mkdir -p assets
            cp icon.png assets/icon.png
          else
            echo "Warning: icon.png not found! Using default."
          fi

      - name: PATCH FLUTTER TEMPLATES (The Ultimate Fix)
        shell: python
        run: |
          import os
          import shutil

          # 1. تحديد موقع Flutter
          flutter_bin = shutil.which("flutter")
          flutter_home = os.path.dirname(os.path.dirname(flutter_bin))
          print(f"Flutter Home: {flutter_home}")

          # 2. البحث عن ملف القالب (AndroidManifest.xml.tmpl)
          target_file = None
          for root, dirs, files in os.walk(flutter_home):
              for file in files:
                  if file == "AndroidManifest.xml.tmpl" and "android.tmpl" in root:
                      target_file = os.path.join(root, file)
                      break
              if target_file: break
          
          if not target_file:
               # بحث احتياطي
               for root, dirs, files in os.walk(flutter_home):
                  if file == "AndroidManifest.xml" and "templates" in root:
                      target_file = os.path.join(root, file)
                      break

          if not target_file:
              print("Error: Template not found!")
              exit(1)

          print(f"Patching: {target_file}")

          with open(target_file, "r") as f:
              content = f.read()

          # --- التعديل الأول: الأذونات (الإنترنت والتخزين) ---
          permissions = '''
          <uses-permission android:name="android.permission.INTERNET"/>
          <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
          <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
          '''
          
          if "android.permission.INTERNET" not in content:
              # وضع الأذونات قبل وسم <application>
              content = content.replace("<application", f"{permissions}\n    <application")
              print("Permissions injected ✅")

          # --- التعديل الثاني: تعطيل Impeller (الشاشة البيضاء) ---
          impeller_fix = '        <meta-data android:name="io.flutter.embedding.android.EnableImpeller" android:value="false" />'
          
          if "EnableImpeller" not in content:
              if "</application>" in content:
                  content = content.replace("</application>", f"{impeller_fix}\n    </application>")
              else:
                  content = content.replace("<application", f"<application\n{impeller_fix}")
              print("Impeller Fix injected ✅")

          with open(target_file, "w") as f:
              f.write(content)

          # --- التعديل الثالث: تحديث SDK إلى 34 ---
          # نبحث عن build.gradle المرتبط
          gradle_file = os.path.join(os.path.dirname(os.path.dirname(target_file)), "build.gradle")
          if not os.path.exists(gradle_file):
             gradle_file = os.path.join(os.path.dirname(os.path.dirname(target_file)), "build.gradle.kts")

          if os.path.exists(gradle_file):
              with open(gradle_file, "r") as f:
                  g_content = f.read()
              
              import re
              g_content = re.sub(r'compileSdkVersion .*', 'compileSdkVersion 34', g_content)
              g_content = re.sub(r'targetSdkVersion .*', 'targetSdkVersion 34', g_content)
              g_content = re.sub(r'compileSdk = .*', 'compileSdk = 34', g_content)
              g_content = re.sub(r'targetSdk = .*', 'targetSdk = 34', g_content)

              with open(gradle_file, "w") as f:
                  f.write(g_content)
              print("SDK updated to 34 ✅")

      - name: Build APK
        run: |
          flet build apk . --project StudentApp --product "الرفيق المدرسي" --verbose

      - name: Find and Rename APK
        run: |
          APK_PATH=$(find . -name "*.apk" | grep "release" | head -n 1)
          if [ -z "$APK_PATH" ]; then APK_PATH=$(find . -name "*.apk" | head -n 1); fi
          if [ -z "$APK_PATH" ]; then echo "Error: APK not found!"; exit 1; fi
          mv "$APK_PATH" StudentApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: StudentApp.apk
