name: Build Android APK (Root Fix)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Ù†Ø³ØªØ®Ø¯Ù… Flet 0.21.2 Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚
      - name: Install Flet
        run: pip install flet==0.21.2

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Ù†Ø³ØªØ®Ø¯Ù… Flutter 3.16.9 (Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠØ³Ø¨Ø¨ Ø´Ø§Ø´Ø© Ø¨ÙŠØ¶Ø§Ø¡)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.9'
          channel: 'stable'

      - name: Create Requirements File
        run: |
          echo "flet==0.21.2" > requirements.txt
          echo "certifi" >> requirements.txt
          echo "typing_extensions" >> requirements.txt
          echo "urllib3" >> requirements.txt
          echo "requests" >> requirements.txt
          echo "charset-normalizer" >> requirements.txt
          echo "idna" >> requirements.txt
          echo "openpyxl" >> requirements.txt

      - name: Prepare Icon
        run: |
          if [ -f "icon.png" ]; then
            echo "Icon found! âœ…"
            mkdir -p assets
            cp icon.png assets/icon.png
          else
            echo "Warning: icon.png not found! Using default."
          fi

      - name: FORCE UPDATE FLUTTER TEMPLATES (The Magic Trick)
        # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªÙ‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù€ Flutter
        # Ù„Ù†Ø¬Ø¨Ø±Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… SDK 34 ÙˆØ­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
        run: |
          FLUTTER_HOME=$(dirname $(dirname $(which flutter)))
          echo "Flutter is installed at: $FLUTTER_HOME"
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
          TEMPLATE_PATH="$FLUTTER_HOME/packages/flutter_tools/templates/app/android.tmpl/app/build.gradle"
          
          if [ -f "$TEMPLATE_PATH" ]; then
            echo "Found template at $TEMPLATE_PATH"
            # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù†Ø³Ø®Ø© SDK Ø¨Ø§Ù„Ù‚ÙˆØ©
            sed -i 's/compileSdkVersion .*/compileSdkVersion 34/g' "$TEMPLATE_PATH"
            sed -i 's/targetSdkVersion .*/targetSdkVersion 34/g' "$TEMPLATE_PATH"
            echo "Successfully injected SDK 34 into Flutter templates! ğŸ’‰"
          else
            echo "Template not found! Trying alternative path..."
            # Ù…Ø³Ø§Ø± Ø¨Ø¯ÙŠÙ„ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø®
            TEMPLATE_PATH_ALT="$FLUTTER_HOME/packages/flutter_tools/templates/app/android.tmpl/app/build.gradle.kts"
            if [ -f "$TEMPLATE_PATH_ALT" ]; then
               echo "Found Kotlin template."
               sed -i 's/compileSdk = .*/compileSdk = 34/g' "$TEMPLATE_PATH_ALT"
               sed -i 's/targetSdk = .*/targetSdk = 34/g' "$TEMPLATE_PATH_ALT"
            fi
          fi

      - name: Build APK (Auto Mode with Hacked Template)
        # Ø§Ù„Ø¢Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„
        run: |
          flet build apk . --project StudentApp --product "Ø§Ù„Ù…ØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ" --verbose

      - name: Find and Rename APK
        run: |
          APK_PATH=$(find . -name "*.apk" | grep "release" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find . -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "Error: APK file not found!"
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          mv "$APK_PATH" StudentApp.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: StudentApp-Android
          path: StudentApp.apk
